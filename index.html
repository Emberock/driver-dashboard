<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Risk Score System</title>
  
  <!-- Libraries for export functionality -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: #f0f2f5;
    }
    
    /* Login Styles */
    .login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .login-container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 400px;
    }
    
    .logo {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .logo h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .logo p {
      color: #666;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      border: 1px solid #fcc;
    }
    
    .error-message.show {
      display: block;
    }
    
    /* Dashboard */
    .dashboard {
      display: none;
    }
    
    .navbar {
      background: #34495e;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .navbar h1 {
      font-size: 20px;
    }
    
    .navbar-right {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .logout-btn {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 600;
    }
    
    .dashboard-content {
      padding: 20px;
    }
    
    /* Admin Controls */
    .admin-panel {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .admin-panel h2 {
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 18px;
    }
    
    .admin-buttons {
      display: flex;
      gap: 10px;
    }
    
    .admin-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      color: white;
      cursor: pointer;
    }
    
    .btn-blue { background: #3498db; }
    .btn-green { background: #16a085; }
    .btn-orange { background: #e67e22; }
    
    /* Stats Grid */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 4px solid;
    }
    
    .stat-card.blue { border-left-color: #3498db; }
    .stat-card.red { border-left-color: #e74c3c; }
    .stat-card.green { border-left-color: #27ae60; }
    .stat-card.orange { border-left-color: #f39c12; }
    
    .stat-number {
      font-size: 36px;
      font-weight: bold;
      color: #2c3e50;
    }
    
    .stat-label {
      color: #7f8c8d;
      margin-top: 5px;
      font-size: 14px;
    }
    
    /* Filters */
    .filters-panel {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filters-panel h3 {
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 18px;
    }
    
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .filter-item {
      display: flex;
      flex-direction: column;
    }
    
    .filter-item label {
      margin-bottom: 5px;
      font-weight: 600;
      color: #2c3e50;
      font-size: 13px;
    }
    
    .filter-item select,
    .filter-item input[type="text"] {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .filter-item select[multiple] {
      height: 80px;
    }
    
    .slider-group {
      display: flex;
      flex-direction: column;
    }
    
    .slider-inputs {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .slider-inputs input[type="number"] {
      width: 60px;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }
    
    .slider-value {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
    }
    
    .filter-actions {
      display: flex;
      gap: 10px;
    }
    
    .filter-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      font-weight: 600;
      color: white;
      cursor: pointer;
    }
    
    .btn-apply { background: #3498db; }
    .btn-reset { background: #95a5a6; }
    .btn-refresh { background: #16a085; }
    .btn-csv { background: #9b59b6; }
    .btn-pdf { background: #e67e22; }
    
    /* Data Table */
    .data-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .data-panel h3 {
      margin-bottom: 15px;
      color: #2c3e50;
      font-size: 18px;
    }
    
    .table-container {
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    .data-table th {
      background: #34495e;
      color: white;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
      border-right: 1px solid #2c3e50;
    }
    
    .data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid #ecf0f1;
      font-size: 13px;
      color: #2c3e50;
      white-space: nowrap;
    }
    
    .data-table tbody tr:hover {
      background: #f8f9fa;
    }
    
    .score-badge {
      padding: 4px 8px;
      border-radius: 3px;
      color: white;
      font-weight: bold;
      font-size: 12px;
      display: inline-block;
    }
    
    .score-high { background: #e74c3c; }
    .score-medium { background: #f39c12; }
    .score-low { background: #27ae60; }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page" id="loginPage">
    <div class="login-container">
      <div class="logo">
        <h1>ðŸš— Driver Risk Score</h1>
        <p>Safety Management System</p>
      </div>
      
      <div class="error-message" id="errorMessage"></div>
      
      <form id="loginForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" required>
        </div>
        
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required>
        </div>
        
        <button type="submit" class="login-button" id="loginBtn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <!-- Navbar -->
    <div class="navbar">
      <h1>ðŸš› Driver Risk Score Dashboard</h1>
      <div class="navbar-right">
        <span id="welcomeText">Welcome, admin</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- Admin Controls -->
      <div class="admin-panel" id="adminPanel" style="display:none;">
        <h2>Admin Controls</h2>
        <div class="admin-buttons">
          <button class="admin-btn btn-blue" onclick="alert('Manage Users')">Manage Users</button>
          <button class="admin-btn btn-green" onclick="alert('View Logs')">View Activity Logs</button>
          <button class="admin-btn btn-orange" onclick="alert('Update Data')">Update Data Source</button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats-container">
        <div class="stat-card blue">
          <div class="stat-number" id="totalDrivers">0</div>
          <div class="stat-label">Total Drivers</div>
        </div>
        <div class="stat-card red">
          <div class="stat-number" id="highRiskDrivers">0</div>
          <div class="stat-label">High Risk Drivers</div>
        </div>
        <div class="stat-card green">
          <div class="stat-number" id="lowRiskDrivers">0</div>
          <div class="stat-label">Low Risk Drivers</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-number" id="avgScore">0</div>
          <div class="stat-label">Average Score</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-panel">
        <h3>Filters</h3>
        <div class="filters-grid">
          <div class="filter-item">
            <label>Location:</label>
            <select id="locationFilter" multiple onchange="applyFilters()">
              <option value="">All Locations</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Region:</label>
            <select id="regionFilter" multiple onchange="applyFilters()">
              <option value="">All Regions</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Division:</label>
            <select id="divisionFilter" multiple onchange="applyFilters()">
              <option value="">All Divisions</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Driver:</label>
            <select id="driverFilter" onchange="applyFilters()">
              <option value="">All</option>
            </select>
          </div>
          
          <div class="filter-item">
            <label>Search:</label>
            <input type="text" id="searchFilter" placeholder="Search drivers..." oninput="applyFilters()">
          </div>
          
          <div class="filter-item slider-group">
            <label>Experience Months:</label>
            <div class="slider-inputs">
              <input type="number" id="minExp" value="0" min="0" max="200" onchange="applyFilters()">
              <span>-</span>
              <input type="number" id="maxExp" value="200" min="0" max="200" onchange="applyFilters()">
            </div>
            <div class="slider-value">Range: 0 - 200+ months</div>
          </div>
        </div>
        
        <div class="filter-actions">
          <button class="filter-btn btn-apply" onclick="applyFilters()">Apply Filters</button>
          <button class="filter-btn btn-reset" onclick="resetFilters()">Reset Filters</button>
          <button class="filter-btn btn-refresh" onclick="loadData()">Refresh Data</button>
          <button class="filter-btn btn-csv" onclick="exportToCSV()">Export to CSV</button>
          <button class="filter-btn btn-pdf" onclick="exportToPDF()">Export to PDF</button>
        </div>
      </div>

      <!-- Data Table -->
      <div class="data-panel">
        <h3>Driver Risk Assessment Data</h3>
        <div id="tableContent" class="loading">Loading data...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let currentUser = null;
    let allData = [];
    let filteredData = [];

    // Login
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('errorMessage');
      const loginBtn = document.getElementById('loginBtn');
      
      errorDiv.classList.remove('show');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';
      
      try {
        const response = await fetch(`${API_BASE}/authenticate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentUser = result.user;
          showDashboard();
        } else {
          errorDiv.textContent = result.message || 'Invalid credentials';
          errorDiv.classList.add('show');
        }
      } catch (error) {
        errorDiv.textContent = 'Connection error';
        errorDiv.classList.add('show');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    });

    function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}`;
      
      if (currentUser.role === 'admin') {
        document.getElementById('adminPanel').style.display = 'block';
      }
      
      loadData();
    }

    async function loadData() {
      document.getElementById('tableContent').innerHTML = '<div class="loading">Loading data...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/getDriverData`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user: currentUser })
        });
        
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        allData = data.rows.map((row, index) => ({
          sno: index + 1,
          fullName: row[0] || '',
          location: row[1] || '',
          region: row[2] || '',
          zone: row[3] || '',
          expDays: row[4] || '',
          expMonths: parseFloat(row[5]) || 0,
          driver: row[6] || '',
          isaacScore: row[7] || '',
          ticketNum: row[8] || '',
          overSpeed: row[9] || '',
          allCollisions: row[10] || '',
          highRiskCollisions: row[11] || '',
          coachable: row[12] || '',
          nonCoachable: row[13] || '',
          score: parseFloat(row[14]) || 0
        }));
        
        filteredData = [...allData];
        populateFilters();
        updateStats();
        displayTable();
      } catch (error) {
        document.getElementById('tableContent').innerHTML = 
          `<div class="loading" style="color:#e74c3c;">Error: ${error.message}</div>`;
      }
    }

    function populateFilters() {
      const locations = [...new Set(allData.map(d => d.location).filter(Boolean))].sort();
      const regions = [...new Set(allData.map(d => d.region).filter(Boolean))].sort();
      const divisions = [...new Set(allData.map(d => d.zone).filter(Boolean))].sort();
      const drivers = [...new Set(allData.map(d => d.driver).filter(Boolean))].sort();
      
      const locationSelect = document.getElementById('locationFilter');
      locationSelect.innerHTML = '<option value="">All Locations</option>';
      locations.forEach(loc => {
        locationSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
      });
      
      const regionSelect = document.getElementById('regionFilter');
      regionSelect.innerHTML = '<option value="">All Regions</option>';
      regions.forEach(reg => {
        regionSelect.innerHTML += `<option value="${reg}">${reg}</option>`;
      });
      
      const divisionSelect = document.getElementById('divisionFilter');
      divisionSelect.innerHTML = '<option value="">All Divisions</option>';
      divisions.forEach(div => {
        divisionSelect.innerHTML += `<option value="${div}">${div}</option>`;
      });
      
      const driverSelect = document.getElementById('driverFilter');
      driverSelect.innerHTML = '<option value="">All</option>';
      drivers.forEach(drv => {
        driverSelect.innerHTML += `<option value="${drv}">${drv}</option>`;
      });
    }

    function applyFilters() {
      const selectedLocations = Array.from(document.getElementById('locationFilter').selectedOptions).map(o => o.value).filter(v => v);
      const selectedRegions = Array.from(document.getElementById('regionFilter').selectedOptions).map(o => o.value).filter(v => v);
      const selectedDivisions = Array.from(document.getElementById('divisionFilter').selectedOptions).map(o => o.value).filter(v => v);
      const selectedDriver = document.getElementById('driverFilter').value;
      const searchText = document.getElementById('searchFilter').value.toLowerCase();
      const minExp = parseInt(document.getElementById('minExp').value) || 0;
      const maxExp = parseInt(document.getElementById('maxExp').value) || 200;
      
      filteredData = allData.filter(d => {
        if (selectedLocations.length > 0 && !selectedLocations.includes(d.location)) return false;
        if (selectedRegions.length > 0 && !selectedRegions.includes(d.region)) return false;
        if (selectedDivisions.length > 0 && !selectedDivisions.includes(d.zone)) return false;
        if (selectedDriver && d.driver !== selectedDriver) return false;
        if (searchText && !d.fullName.toLowerCase().includes(searchText)) return false;
        if (d.expMonths < minExp || d.expMonths > maxExp) return false;
        return true;
      });
      
      updateStats();
      displayTable();
    }

    function resetFilters() {
      document.getElementById('locationFilter').selectedIndex = -1;
      document.getElementById('regionFilter').selectedIndex = -1;
      document.getElementById('divisionFilter').selectedIndex = -1;
      document.getElementById('driverFilter').value = '';
      document.getElementById('searchFilter').value = '';
      document.getElementById('minExp').value = 0;
      document.getElementById('maxExp').value = 200;
      
      filteredData = [...allData];
      updateStats();
      displayTable();
    }

    function updateStats() {
      const total = filteredData.length;
      const highRisk = filteredData.filter(d => d.score < -10).length;
      const lowRisk = filteredData.filter(d => d.score >= -10).length;
      const avgScore = total > 0 ? (filteredData.reduce((sum, d) => sum + d.score, 0) / total).toFixed(1) : '0.0';
      
      document.getElementById('totalDrivers').textContent = total;
      document.getElementById('highRiskDrivers').textContent = highRisk;
      document.getElementById('lowRiskDrivers').textContent = lowRisk;
      document.getElementById('avgScore').textContent = avgScore;
    }

    function displayTable() {
      const content = document.getElementById('tableContent');
      
      if (filteredData.length === 0) {
        content.innerHTML = '<div class="loading">No data matches filters</div>';
        return;
      }
      
      let html = '<div class="table-container"><table class="data-table">';
      html += '<thead><tr>';
      html += '<th>S.No.</th><th>Full Name</th><th>Location</th><th>Region</th><th>Zone</th>';
      html += '<th>Experience Days</th><th>Exp Months</th><th>Driver</th><th>ISAAC Score</th>';
      html += '<th>Ticket #</th><th>Over Speed</th><th>All Collisions</th><th>High Risk Collisions</th>';
      html += '<th>Coachable</th><th>Non Coachable</th><th>Score</th>';
      html += '</tr></thead><tbody>';
      
      filteredData.forEach(row => {
        const scoreClass = row.score < -20 ? 'score-high' : row.score < -10 ? 'score-medium' : 'score-low';
        html += `<tr>
          <td>${row.sno}</td>
          <td>${row.fullName}</td>
          <td>${row.location}</td>
          <td>${row.region}</td>
          <td>${row.zone}</td>
          <td>${row.expDays}</td>
          <td>${row.expMonths}</td>
          <td>${row.driver}</td>
          <td>${row.isaacScore}</td>
          <td>${row.ticketNum}</td>
          <td>${row.overSpeed}</td>
          <td>${row.allCollisions}</td>
          <td>${row.highRiskCollisions}</td>
          <td>${row.coachable}</td>
          <td>${row.nonCoachable}</td>
          <td><span class="score-badge ${scoreClass}">${row.score.toFixed(1)}</span></td>
        </tr>`;
      });
      
      html += '</tbody></table></div>';
      content.innerHTML = html;
    }

    function exportToCSV() {
      if (filteredData.length === 0) {
        alert('No data to export');
        return;
      }
      
      const headers = ['S.No.', 'Full Name', 'Location', 'Region', 'Zone', 'Experience Days', 'Exp Months', 
                      'Driver', 'ISAAC Score', 'Ticket #', 'Over Speed', 'All Collisions', 
                      'High Risk Collisions', 'Coachable', 'Non Coachable', 'Score'];
      
      let csv = headers.join(',') + '\n';
      filteredData.forEach(row => {
        csv += `${row.sno},"${row.fullName}","${row.location}","${row.region}","${row.zone}",${row.expDays},${row.expMonths},"${row.driver}",${row.isaacScore},${row.ticketNum},${row.overSpeed},${row.allCollisions},${row.highRiskCollisions},${row.coachable},${row.nonCoachable},${row.score.toFixed(1)}\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `driver_data_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function exportToPDF() {
      if (filteredData.length === 0) {
        alert('No data to export');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      
      doc.setFontSize(16);
      doc.text('Driver Risk Score Report', 14, 15);
      doc.setFontSize(10);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 22);
      doc.text(`Total Records: ${filteredData.length}`, 14, 27);
      
      const tableData = filteredData.map(row => [
        row.sno, row.fullName, row.location, row.region, row.zone,
        row.expDays, row.expMonths, row.driver, row.isaacScore,
        row.ticketNum, row.overSpeed, row.allCollisions, row.highRiskCollisions,
        row.coachable, row.nonCoachable, row.score.toFixed(1)
      ]);
      
      doc.autoTable({
        head: [['No.', 'Name', 'Loc', 'Reg', 'Zone', 'Days', 'Months', 'Driver', 'ISAAC', 
                'Ticket', 'Speed', 'Coll', 'High', 'Coach', 'Non-C', 'Score']],
        body: tableData,
        startY: 32,
        styles: { fontSize: 7 },
        headStyles: { fillColor: [52, 73, 94] }
      });
      
      doc.save(`driver_report_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function logout() {
      currentUser = null;
      allData = [];
      filteredData = [];
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }
  </script>
</body>
</html>
