<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Risk Score Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
    }

    /* Login Page */
    .login-page {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      width: 100%;
      max-width: 400px;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .logo p {
      color: #666;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .login-button:hover {
      transform: translateY(-2px);
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }

    .error-message.show {
      display: block;
    }

    /* Dashboard */
    .dashboard {
      display: none;
      min-height: 100vh;
    }

    .navbar {
      background: #34495e;
      color: white;
      padding: 18px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    .navbar h1 {
      font-size: 22px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .navbar-right span {
      font-size: 14px;
    }

    .logout-btn {
      padding: 10px 24px;
      background: #95a5a6;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #7f8c8d;
    }

    .dashboard-content {
      padding: 25px;
      max-width: 1800px;
      margin: 0 auto;
    }

    /* Admin Controls */
    .admin-controls {
      background: white;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 25px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .admin-controls h2 {
      margin-bottom: 18px;
      color: #2c3e50;
      font-size: 18px;
      font-weight: 600;
    }

    .admin-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .admin-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .admin-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .admin-btn.blue { background: #3498db; }
    .admin-btn.green { background: #16a085; }
    .admin-btn.orange { background: #e67e22; }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-card {
      background: white;
      padding: 28px 24px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      border-left: 5px solid;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .stat-card.blue { border-color: #3498db; }
    .stat-card.red { border-color: #e74c3c; }
    .stat-card.green { border-color: #27ae60; }
    .stat-card.orange { border-color: #f39c12; }

    .stat-number {
      font-size: 42px;
      font-weight: 700;
      color: #2c3e50;
      line-height: 1;
    }

    .stat-label {
      font-size: 14px;
      color: #7f8c8d;
      margin-top: 8px;
      font-weight: 500;
    }

    /* Filters */
    .filters-section {
      background: white;
      padding: 25px;
      border-radius: 8px;
      margin-bottom: 25px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .filters-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 18px;
      font-weight: 600;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
      margin-bottom: 22px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
    }

    .filter-group label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #2c3e50;
      font-size: 13px;
    }

    .filter-group select,
    .filter-group input[type="text"] {
      padding: 11px 12px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      font-size: 14px;
      background: white;
      transition: border-color 0.3s;
    }

    .filter-group select:focus,
    .filter-group input[type="text"]:focus {
      outline: none;
      border-color: #3498db;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
    }

    .slider-container input[type="range"] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #dcdde1;
      outline: none;
      -webkit-appearance: none;
    }

    .slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #3498db;
      cursor: pointer;
    }

    .slider-container input[type="range"]::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #3498db;
      cursor: pointer;
      border: none;
    }

    .slider-value {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 6px;
    }

    .filter-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 11px 22px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      color: white;
      font-size: 14px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .filter-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .filter-btn.apply { background: #3498db; }
    .filter-btn.reset { background: #95a5a6; }
    .filter-btn.refresh { background: #16a085; }
    .filter-btn.csv { background: #9b59b6; }
    .filter-btn.pdf { background: #e67e22; }

    /* Data Section */
    .data-section {
      background: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .data-section h3 {
      margin-bottom: 20px;
      color: #2c3e50;
      font-size: 18px;
      font-weight: 600;
    }

    .table-wrapper {
      overflow-x: auto;
      overflow-y: auto;
      max-height: 600px;
      border: 1px solid #ecf0f1;
      border-radius: 6px;
    }

    .data-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 1800px;
    }

    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table th {
      padding: 14px 12px;
      text-align: left;
      background: #34495e;
      color: white;
      font-weight: 600;
      font-size: 13px;
      border-bottom: 2px solid #2c3e50;
      white-space: nowrap;
    }

    .data-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ecf0f1;
      font-size: 13px;
      color: #2c3e50;
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    .data-table tbody tr:last-child td {
      border-bottom: none;
    }

    .score-badge {
      padding: 5px 10px;
      border-radius: 4px;
      color: white;
      font-weight: 700;
      display: inline-block;
      font-size: 12px;
      min-width: 50px;
      text-align: center;
    }

    .score-high { background: #e74c3c; }
    .score-medium { background: #f39c12; }
    .score-low { background: #27ae60; }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
      font-size: 16px;
    }

    .no-data {
      text-align: center;
      padding: 60px 20px;
      color: #7f8c8d;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .dashboard-content {
        padding: 15px;
      }
      
      .filters-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Login Page -->
  <div class="login-page" id="loginPage">
    <div class="login-container">
      <div class="logo">
        <h1>ðŸš— Driver Risk Score</h1>
        <p>Safety Management System</p>
      </div>
      
      <div class="error-message" id="errorMessage"></div>
      
      <form id="loginForm">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" required autocomplete="username">
        </div>
        
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" required autocomplete="current-password">
        </div>
        
        <button type="submit" class="login-button" id="loginBtn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard" id="dashboard">
    <nav class="navbar">
      <h1>ðŸš› Driver Risk Score Dashboard</h1>
      <div class="navbar-right">
        <span id="welcomeText">Welcome, admin</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </nav>

    <div class="dashboard-content">
      <!-- Admin Controls -->
      <div class="admin-controls" id="adminControls" style="display:none;">
        <h2>Admin Controls</h2>
        <div class="admin-buttons">
          <button class="admin-btn blue" onclick="alert('Manage Users - Coming soon!')">Manage Users</button>
          <button class="admin-btn green" onclick="alert('Activity Logs - Coming soon!')">View Activity Logs</button>
          <button class="admin-btn orange" onclick="alert('Update Data - Coming soon!')">Update Data Source</button>
        </div>
      </div>

      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card blue">
          <div class="stat-number" id="totalDrivers">0</div>
          <div class="stat-label">Total Drivers</div>
        </div>
        <div class="stat-card red">
          <div class="stat-number" id="highRiskDrivers">0</div>
          <div class="stat-label">High Risk Drivers</div>
        </div>
        <div class="stat-card green">
          <div class="stat-number" id="lowRiskDrivers">0</div>
          <div class="stat-label">Low Risk Drivers</div>
        </div>
        <div class="stat-card orange">
          <div class="stat-number" id="avgScore">0</div>
          <div class="stat-label">Average Score</div>
        </div>
      </div>

      <!-- Filters -->
      <div class="filters-section">
        <h3>Filters</h3>
        <div class="filters-grid">
          <div class="filter-group">
            <label>Location:</label>
            <select id="filterLocation">
              <option value="">All Locations</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Region:</label>
            <select id="filterRegion">
              <option value="">All Regions</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Division:</label>
            <select id="filterZone">
              <option value="">All Divisions</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Driver:</label>
            <select id="filterDriver">
              <option value="">All</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Search:</label>
            <input type="text" id="searchBox" placeholder="Search drivers...">
          </div>
          <div class="filter-group slider-container">
            <label>Experience Months:</label>
            <input type="range" id="expRange" min="0" max="200" value="0" step="1">
            <div class="slider-value">Range: <span id="expValue">0 - 200+ months</span></div>
          </div>
        </div>
        <div class="filter-actions">
          <button class="filter-btn apply" onclick="applyFilters()">Apply Filters</button>
          <button class="filter-btn reset" onclick="resetFilters()">Reset Filters</button>
          <button class="filter-btn refresh" onclick="refreshData()">Refresh Data</button>
          <button class="filter-btn csv" onclick="exportToCSV()">Export to CSV</button>
          <button class="filter-btn pdf" onclick="exportToPDF()">Export to PDF</button>
        </div>
      </div>

      <!-- Data Table -->
      <div class="data-section">
        <h3>Driver Risk Assessment Data</h3>
        <div id="tableContent" class="loading">Loading data...</div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let currentUser = null;
    let allData = [];
    let filteredData = [];

    // Login Handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('errorMessage');
      const loginBtn = document.getElementById('loginBtn');
      
      errorDiv.classList.remove('show');
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';
      
      try {
        const response = await fetch(`${API_BASE}/authenticate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ username, password })
        });
        
        const result = await response.json();
        
        if (result.success) {
          currentUser = result.user;
          await showDashboard();
        } else {
          errorDiv.textContent = result.message || 'Invalid credentials';
          errorDiv.classList.add('show');
        }
      } catch (error) {
        console.error('Login error:', error);
        errorDiv.textContent = 'Connection error. Please try again.';
        errorDiv.classList.add('show');
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    });

    async function showDashboard() {
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('welcomeText').textContent = `Welcome, ${currentUser.username}`;
      
      if (currentUser.role === 'admin') {
        document.getElementById('adminControls').style.display = 'block';
      }
      
      await loadData();
    }

    async function loadData() {
      document.getElementById('tableContent').innerHTML = '<div class="loading">Loading data...</div>';
      
      try {
        const response = await fetch(`${API_BASE}/getDriverData`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ user: currentUser })
        });
        
        const data = await response.json();
        
        if (data.error) throw new Error(data.error);
        
        // Map data with all 15 columns
        allData = data.rows.map((row, index) => ({
          sno: index + 1,
          fullName: row[0] || '',
          location: row[1] || '',
          region: row[2] || '',
          zone: row[3] || '',
          experienceDays: row[4] || '',
          expMonths: parseFloat(row[5]) || 0,
          driver: row[6] || '',
          isaacScore: row[7] || '',
          ticketNum: row[8] || '',
          overSpeed: row[9] || '',
          allCollisions: row[10] || '',
          highRiskCollisions: row[11] || '',
          coachable: row[12] || '',
          nonCoachable: row[13] || '',
          score: parseFloat(row[14]) || 0
        }));
        
        filteredData = [...allData];
        populateFilters();
        updateStats();
        displayTable();
      } catch (error) {
        console.error('Load data error:', error);
        document.getElementById('tableContent').innerHTML = 
          `<div class="no-data" style="color: #e74c3c;">Error loading data: ${error.message}</div>`;
      }
    }

    function populateFilters() {
      const locations = [...new Set(allData.map(d => d.location).filter(Boolean))].sort();
      const regions = [...new Set(allData.map(d => d.region).filter(Boolean))].sort();
      const zones = [...new Set(allData.map(d => d.zone).filter(Boolean))].sort();
      const drivers = [...new Set(allData.map(d => d.driver).filter(Boolean))].sort();
      
      populateSelect('filterLocation', locations);
      populateSelect('filterRegion', regions);
      populateSelect('filterZone', zones);
      populateSelect('filterDriver', drivers);
    }

    function populateSelect(id, options) {
      const select = document.getElementById(id);
      const firstOption = select.options[0].text;
      select.innerHTML = `<option value="">${firstOption}</option>`;
      options.forEach(opt => {
        select.innerHTML += `<option value="${opt}">${opt}</option>`;
      });
    }

    function updateStats() {
      const total = filteredData.length;
      const highRisk = filteredData.filter(d => d.score < -10).length;
      const lowRisk = filteredData.filter(d => d.score >= -10).length;
      const avgScore = total > 0 ? (filteredData.reduce((sum, d) => sum + d.score, 0) / total).toFixed(1) : '0.0';
      
      document.getElementById('totalDrivers').textContent = total;
      document.getElementById('highRiskDrivers').textContent = highRisk;
      document.getElementById('lowRiskDrivers').textContent = lowRisk;
      document.getElementById('avgScore').textContent = avgScore;
    }

    function displayTable() {
      const content = document.getElementById('tableContent');
      
      if (filteredData.length === 0) {
        content.innerHTML = '<div class="no-data">No data matches your filters.</div>';
        return;
      }
      
      let html = '<div class="table-wrapper"><table class="data-table">';
      html += '<thead><tr>';
      html += '<th>S.No.</th>';
      html += '<th>Full Name</th>';
      html += '<th>Location</th>';
      html += '<th>Region</th>';
      html += '<th>Zone</th>';
      html += '<th>Experience Days</th>';
      html += '<th>Exp Months</th>';
      html += '<th>Driver</th>';
      html += '<th>ISAAC Score</th>';
      html += '<th>Ticket #</th>';
      html += '<th>Over Speed</th>';
      html += '<th>All Collisions</th>';
      html += '<th>High Risk Collisions</th>';
      html += '<th>Coachable</th>';
      html += '<th>Non Coachable</th>';
      html += '<th>Score</th>';
      html += '</tr></thead><tbody>';
      
      filteredData.forEach(row => {
        const scoreClass = row.score < -20 ? 'score-high' : row.score < -10 ? 'score-medium' : 'score-low';
        html += '<tr>';
        html += `<td>${row.sno}</td>`;
        html += `<td>${row.fullName}</td>`;
        html += `<td>${row.location}</td>`;
        html += `<td>${row.region}</td>`;
        html += `<td>${row.zone}</td>`;
        html += `<td>${row.experienceDays}</td>`;
        html += `<td>${row.expMonths}</td>`;
        html += `<td>${row.driver}</td>`;
        html += `<td>${row.isaacScore}</td>`;
        html += `<td>${row.ticketNum}</td>`;
        html += `<td>${row.overSpeed}</td>`;
        html += `<td>${row.allCollisions}</td>`;
        html += `<td>${row.highRiskCollisions}</td>`;
        html += `<td>${row.coachable}</td>`;
        html += `<td>${row.nonCoachable}</td>`;
        html += `<td><span class="score-badge ${scoreClass}">${row.score.toFixed(1)}</span></td>`;
        html += '</tr>';
      });
      
      html += '</tbody></table></div>';
      content.innerHTML = html;
    }

    function applyFilters() {
      const location = document.getElementById('filterLocation').value;
      const region = document.getElementById('filterRegion').value;
      const zone = document.getElementById('filterZone').value;
      const driver = document.getElementById('filterDriver').value;
      const search = document.getElementById('searchBox').value.toLowerCase();
      const expRange = parseInt(document.getElementById('expRange').value);
      
      filteredData = allData.filter(d => {
        if (location && d.location !== location) return false;
        if (region && d.region !== region) return false;
        if (zone && d.zone !== zone) return false;
        if (driver && d.driver !== driver) return false;
        if (search && !d.fullName.toLowerCase().includes(search)) return false;
        if (expRange > 0 && d.expMonths < expRange) return false;
        return true;
      });
      
      updateStats();
      displayTable();
    }

    function resetFilters() {
      document.getElementById('filterLocation').value = '';
      document.getElementById('filterRegion').value = '';
      document.getElementById('filterZone').value = '';
      document.getElementById('filterDriver').value = '';
      document.getElementById('searchBox').value = '';
      document.getElementById('expRange').value = 0;
      document.getElementById('expValue').textContent = '0 - 200+ months';
      
      filteredData = [...allData];
      updateStats();
      displayTable();
    }

    function refreshData() {
      loadData();
    }

    function exportToCSV() {
      if (filteredData.length === 0) {
        alert('No data to export!');
        return;
      }

      const headers = ['S.No.', 'Full Name', 'Location', 'Region', 'Zone', 'Experience Days', 
                      'Exp Months', 'Driver', 'ISAAC Score', 'Ticket #', 'Over Speed', 
                      'All Collisions', 'High Risk Collisions', 'Coachable', 'Non Coachable', 'Score'];
      
      let csvContent = headers.join(',') + '\n';
      
      filteredData.forEach(row => {
        const line = [
          row.sno,
          `"${row.fullName}"`,
          `"${row.location}"`,
          `"${row.region}"`,
          `"${row.zone}"`,
          row.experienceDays,
          row.expMonths,
          `"${row.driver}"`,
          row.isaacScore,
          row.ticketNum,
          row.overSpeed,
          row.allCollisions,
          row.highRiskCollisions,
          row.coachable,
          row.nonCoachable,
          row.score.toFixed(1)
        ].join(',');
        csvContent += line + '\n';
      });
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `driver_risk_data_${new Date().toISOString().split('T')[0]}.csv`;
      link.click();
    }

    function exportToPDF() {
      if (filteredData.length === 0) {
        alert('No data to export!');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('landscape');
      
      doc.setFontSize(18);
      doc.text('Driver Risk Score Report', 14, 15);
      
      doc.setFontSize(10);
      doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 22);
      doc.text(`Total Records: ${filteredData.length}`, 14, 27);
      
      const tableData = filteredData.map(row => [
        row.sno,
        row.fullName,
        row.location,
        row.region,
        row.zone,
        row.experienceDays,
        row.expMonths,
        row.driver,
        row.isaacScore,
        row.ticketNum,
        row.overSpeed,
        row.allCollisions,
        row.highRiskCollisions,
        row.coachable,
        row.nonCoachable,
        row.score.toFixed(1)
      ]);
      
      doc.autoTable({
        head: [['S.No.', 'Full Name', 'Location', 'Region', 'Zone', 'Exp Days', 'Exp Months', 
                'Driver', 'ISAAC', 'Ticket', 'Speed', 'Collisions', 'High Risk', 'Coachable', 'Non-Coach', 'Score']],
        body: tableData,
        startY: 32,
        styles: { fontSize: 7, cellPadding: 2 },
        headStyles: { fillColor: [52, 73, 94], textColor: 255 },
        alternateRowStyles: { fillColor: [245, 245, 245] },
        columnStyles: {
          0: { cellWidth: 12 },
          1: { cellWidth: 25 }
        }
      });
      
      doc.save(`driver_risk_report_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function logout() {
      currentUser = null;
      allData = [];
      filteredData = [];
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginForm').reset();
      document.getElementById('errorMessage').classList.remove('show');
    }

    // Experience slider real-time update
    document.getElementById('expRange').addEventListener('input', (e) => {
      const value = e.target.value;
      document.getElementById('expValue').textContent = value == 0 ? '0 - 200+ months' : `${value} - 200+ months`;
    });

    // Search box real-time filtering
    document.getElementById('searchBox').addEventListener('input', () => {
      applyFilters();
    });
  </script>
</body>
</html>
