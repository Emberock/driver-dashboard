<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver Risk Score System</title>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f7fa;
    }

    /* Login */
    .login-page {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .login-container {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      width: 400px;
      max-width: 90%;
    }

    .logo {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo h1 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .logo p {
      color: #666;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
    }

    .login-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .error-message {
      background: #fee;
      color: #c33;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
      border: 1px solid #fcc;
    }

    .error-message.show {
      display: block;
    }

    /* Dashboard */
    .dashboard {
      display: none;
      min-height: 100vh;
    }

    .navbar {
      background: #2c3e50;
      color: white;
      padding: 18px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .navbar h1 {
      font-size: 20px;
      font-weight: 600;
    }

    .navbar-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logout-btn {
      padding: 10px 24px;
      background: #7f8c8d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .content {
      max-width: 100%;
      margin: 0 auto;
      padding: 25px;
    }

    /* Admin */
    .admin-section {
      background: white;
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .admin-section h2 {
      color: #2c3e50;
      font-size: 18px;
      margin-bottom: 18px;
      font-weight: 600;
    }

    .admin-buttons {
      display: flex;
      gap: 12px;
    }

    .admin-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .admin-btn.blue { background: #3498db; }
    .admin-btn.green { background: #16a085; }
    .admin-btn.orange { background: #e67e22; }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 25px;
    }

    .stat-box {
      background: white;
      padding: 28px 24px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 5px solid;
    }

    .stat-box.blue { border-left-color: #3498db; }
    .stat-box.red { border-left-color: #e74c3c; }
    .stat-box.green { border-left-color: #27ae60; }
    .stat-box.orange { border-left-color: #f39c12; }

    .stat-value {
      font-size: 42px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .stat-name {
      font-size: 14px;
      color: #7f8c8d;
      font-weight: 500;
    }

    /* Filters */
    .filters-section {
      background: white;
      padding: 25px;
      margin-bottom: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .filters-section h3 {
      color: #2c3e50;
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 18px;
      margin-bottom: 22px;
    }

    .filter-col {
      display: flex;
      flex-direction: column;
    }

    .filter-col label {
      font-weight: 600;
      margin-bottom: 6px;
      color: #2c3e50;
      font-size: 13px;
    }

    .filter-col select {
      padding: 10px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      font-size: 14px;
      background: white;
    }

    /* Checkbox list */
    .checkbox-list {
      border: 1px solid #dcdde1;
      border-radius: 6px;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      background: white;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      cursor: pointer;
    }

    .checkbox-item input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
    }

    .checkbox-item label {
      cursor: pointer;
      font-size: 13px;
      font-weight: normal;
      color: #2c3e50;
      margin: 0;
    }

    .filter-col input[type="text"] {
      padding: 10px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      font-size: 14px;
    }

    .exp-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .exp-inputs input {
      width: 65px;
      padding: 10px 8px;
      border: 1px solid #dcdde1;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
    }

    .range-label {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 4px;
    }

    .filter-buttons {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 11px 22px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-apply { background: #3498db; }
    .btn-reset { background: #95a5a6; }
    .btn-refresh { background: #16a085; }
    .btn-csv { background: #9b59b6; }
    .btn-pdf { background: #e67e22; }

    /* Table */
    .table-section {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .table-section h3 {
      color: #2c3e50;
      font-size: 18px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    .table-wrap {
      overflow-y: auto;
      max-height: 600px;
      border: 1px solid #ecf0f1;
      border-radius: 8px;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      table-layout: fixed;
    }

    .data-table thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table th {
      background: #34495e;
      color: white;
      padding: 12px 6px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
    }

    .data-table th:nth-child(1) { width: 50px; }
    .data-table th:nth-child(2) { width: 150px; }
    .data-table th:nth-child(3) { width: 100px; }
    .data-table th:nth-child(4) { width: 70px; }
    .data-table th:nth-child(5) { width: 80px; }
    .data-table th:nth-child(6) { width: 100px; }
    .data-table th:nth-child(7) { width: 80px; }
    .data-table th:nth-child(8) { width: 60px; }
    .data-table th:nth-child(9) { width: 90px; }
    .data-table th:nth-child(10) { width: 70px; }
    .data-table th:nth-child(11) { width: 80px; }
    .data-table th:nth-child(12) { width: 90px; }
    .data-table th:nth-child(13) { width: 100px; }
    .data-table th:nth-child(14) { width: 80px; }
    .data-table th:nth-child(15) { width: 90px; }
    .data-table th:nth-child(16) { width: 80px; }

    .data-table td {
      padding: 10px 6px;
      border-bottom: 1px solid #ecf0f1;
      color: #2c3e50;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .data-table tbody tr:hover {
      background: #f8f9fa;
    }

    .score-cell {
      padding: 5px 10px;
      border-radius: 4px;
      font-weight: 700;
      text-align: center;
      display: inline-block;
      width: 60px;
      color: white;
      font-size: 11px;
    }

    .loading {
      text-align: center;
      padding: 60px;
      color: #7f8c8d;
    }
  </style>
</head>
<body>
  <div class="login-page" id="loginPage">
    <div class="login-container">
      <div class="logo">
        <h1>ðŸš— Driver Risk Score</h1>
        <p>Safety Management System</p>
      </div>
      <div class="error-message" id="errorMsg"></div>
      <form id="loginForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" required>
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required>
        </div>
        <button type="submit" class="login-button" id="loginBtn">Sign In</button>
      </form>
    </div>
  </div>

  <div class="dashboard" id="dashboard">
    <div class="navbar">
      <h1>ðŸš› Driver Risk Score Dashboard</h1>
      <div class="navbar-right">
        <span id="welcomeMsg">Welcome, admin</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="content">
      <div class="admin-section" id="adminSection" style="display:none;">
        <h2>Admin Controls</h2>
        <div class="admin-buttons">
          <button class="admin-btn blue">Manage Users</button>
          <button class="admin-btn green">View Activity Logs</button>
          <button class="admin-btn orange">Update Data Source</button>
        </div>
      </div>

      <div class="stats">
        <div class="stat-box blue">
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-name">Total Drivers</div>
        </div>
        <div class="stat-box red">
          <div class="stat-value" id="statHighRisk">0</div>
          <div class="stat-name">High Risk Drivers</div>
        </div>
        <div class="stat-box green">
          <div class="stat-value" id="statLowRisk">0</div>
          <div class="stat-name">Low Risk Drivers</div>
        </div>
        <div class="stat-box orange">
          <div class="stat-value" id="statAvg">0</div>
          <div class="stat-name">Average Score</div>
        </div>
      </div>

      <div class="filters-section">
        <h3>Filters</h3>
        <div class="filter-grid">
          <div class="filter-col">
            <label>Location:</label>
            <div class="checkbox-list" id="filterLoc"></div>
          </div>
          <div class="filter-col">
            <label>Region:</label>
            <div class="checkbox-list" id="filterReg"></div>
          </div>
          <div class="filter-col">
            <label>Division:</label>
            <div class="checkbox-list" id="filterDiv"></div>
          </div>
          <div class="filter-col">
            <label>Driver:</label>
            <select id="filterDrv"><option value="">All</option></select>
          </div>
          <div class="filter-col">
            <label>Search:</label>
            <input type="text" id="filterSearch" placeholder="Search drivers...">
          </div>
          <div class="filter-col">
            <label>Experience Months:</label>
            <div class="exp-inputs">
              <input type="number" id="expMin" value="0" min="0">
              <span>-</span>
              <input type="number" id="expMax" value="200" min="0">
            </div>
            <div class="range-label">Range: 0 - 200+ months</div>
          </div>
        </div>
        <div class="filter-buttons">
          <button class="btn btn-apply" onclick="applyFilters()">Apply Filters</button>
          <button class="btn btn-reset" onclick="resetFilters()">Reset Filters</button>
          <button class="btn btn-refresh" onclick="loadDriverData()">Refresh Data</button>
          <button class="btn btn-csv" onclick="exportCSV()">Export to CSV</button>
          <button class="btn btn-pdf" onclick="exportPDF()">Export to PDF</button>
        </div>
      </div>

      <div class="table-section">
        <h3>Driver Risk Assessment Data</h3>
        <div id="tableArea" class="loading">Loading data...</div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = '/api';
    let user = null;
    let allDrivers = [];
    let displayDrivers = [];

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errMsg = document.getElementById('errorMsg');
      const btn = document.getElementById('loginBtn');
      
      errMsg.classList.remove('show');
      btn.disabled = true;
      btn.textContent = 'Signing in...';
      
      try {
        const res = await fetch(`${API_URL}/authenticate`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({username, password})
        });
        
        if (!res.ok) {
          throw new Error('Authentication failed');
        }
        
        const data = await res.json();
        
        console.log('Auth response:', data); // Debug
        
        if (data.success) {
          user = data.user;
          console.log('User logged in:', user); // Debug
          showDash();
        } else {
          errMsg.textContent = data.message || 'Invalid credentials';
          errMsg.classList.add('show');
        }
      } catch (err) {
        console.error('Login error:', err);
        errMsg.textContent = 'Connection error: ' + err.message;
        errMsg.classList.add('show');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    });

    function showDash() {
      console.log('Showing dashboard for user:', user); // Debug
      document.getElementById('loginPage').style.display = 'none';
      document.getElementById('dashboard').style.display = 'block';
      document.getElementById('welcomeMsg').textContent = `Welcome, ${user.username}`;
      if (user.role === 'admin') document.getElementById('adminSection').style.display = 'block';
      loadDriverData();
    }

    async function loadDriverData() {
      console.log('Loading data for user:', user); // Debug
      
      if (!user) {
        console.error('No user found!');
        document.getElementById('tableArea').innerHTML = '<div class="loading" style="color:#e74c3c;">Error: Not logged in</div>';
        return;
      }
      
      document.getElementById('tableArea').innerHTML = '<div class="loading">Loading data...</div>';
      
      try {
        console.log('Fetching driver data...'); // Debug
        
        const res = await fetch(`${API_URL}/getDriverData`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({user: user})
        });
        
        console.log('Response status:', res.status); // Debug
        
        if (!res.ok) {
          throw new Error(`API returned ${res.status}`);
        }
        
        const data = await res.json();
        
        console.log('API Response:', data); // Debug
        console.log('Rows received:', data.rows ? data.rows.length : 0); // Debug
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        if (!data.rows || data.rows.length === 0) {
          document.getElementById('tableArea').innerHTML = '<div class="loading">No data available from Google Sheets</div>';
          return;
        }
        
        // Map all 15 columns
        allDrivers = data.rows.map((row, idx) => ({
          sno: idx + 1,
          fullName: row[0] || '',
          location: row[1] || '',
          region: row[2] || '',
          zone: row[3] || '',
          expDays: row[4] || '',
          expMonths: parseFloat(row[5]) || 0,
          driver: row[6] || '',
          isaacScore: row[7] || '',
          ticketNum: row[8] || '',
          overSpeed: row[9] || '',
          allCollisions: row[10] || '',
          highRiskCollisions: row[11] || '',
          coachable: row[12] || '',
          nonCoachable: row[13] || '',
          score: parseFloat(row[14]) || 0
        }));
        
        console.log('Total drivers loaded:', allDrivers.length); // Debug
        
        displayDrivers = [...allDrivers];
        setupFilters();
        updateStats();
        renderTable();
        
      } catch (err) {
        console.error('Load error:', err);
        document.getElementById('tableArea').innerHTML = `<div class="loading" style="color:#e74c3c;">Error loading data: ${err.message}</div>`;
      }
    }

    function setupFilters() {
      const locs = [...new Set(allDrivers.map(d => d.location).filter(Boolean))].sort();
      const regs = [...new Set(allDrivers.map(d => d.region).filter(Boolean))].sort();
      const divs = [...new Set(allDrivers.map(d => d.zone).filter(Boolean))].sort();
      const drvs = [...new Set(allDrivers.map(d => d.driver).filter(Boolean))].sort();
      
      document.getElementById('filterLoc').innerHTML = locs.map((l, i) => `
        <div class="checkbox-item">
          <input type="checkbox" id="loc_${i}" value="${l}" onchange="applyFilters()">
          <label for="loc_${i}">${l}</label>
        </div>
      `).join('');
      
      document.getElementById('filterReg').innerHTML = regs.map((r, i) => `
        <div class="checkbox-item">
          <input type="checkbox" id="reg_${i}" value="${r}" onchange="applyFilters()">
          <label for="reg_${i}">${r}</label>
        </div>
      `).join('');
      
      document.getElementById('filterDiv').innerHTML = divs.map((d, i) => `
        <div class="checkbox-item">
          <input type="checkbox" id="div_${i}" value="${d}" onchange="applyFilters()">
          <label for="div_${i}">${d}</label>
        </div>
      `).join('');
      
      document.getElementById('filterDrv').innerHTML = '<option value="">All</option>' + 
        drvs.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    function applyFilters() {
      const selLocs = Array.from(document.querySelectorAll('#filterLoc input:checked')).map(cb => cb.value);
      const selRegs = Array.from(document.querySelectorAll('#filterReg input:checked')).map(cb => cb.value);
      const selDivs = Array.from(document.querySelectorAll('#filterDiv input:checked')).map(cb => cb.value);
      const selDrv = document.getElementById('filterDrv').value;
      const searchTxt = document.getElementById('filterSearch').value.toLowerCase();
      const minExp = parseInt(document.getElementById('expMin').value) || 0;
      const maxExp = parseInt(document.getElementById('expMax').value) || 200;
      
      displayDrivers = allDrivers.filter(d => {
        if (selLocs.length && !selLocs.includes(d.location)) return false;
        if (selRegs.length && !selRegs.includes(d.region)) return false;
        if (selDivs.length && !selDivs.includes(d.zone)) return false;
        if (selDrv && d.driver !== selDrv) return false;
        if (searchTxt && !d.fullName.toLowerCase().includes(searchTxt)) return false;
        if (d.expMonths < minExp || d.expMonths > maxExp) return false;
        return true;
      });
      updateStats();
      renderTable();
    }

    function resetFilters() {
      document.querySelectorAll('.checkbox-list input').forEach(cb => cb.checked = false);
      document.getElementById('filterDrv').value = '';
      document.getElementById('filterSearch').value = '';
      document.getElementById('expMin').value = 0;
      document.getElementById('expMax').value = 200;
      displayDrivers = [...allDrivers];
      updateStats();
      renderTable();
    }

    function updateStats() {
      const total = displayDrivers.length;
      const highRisk = displayDrivers.filter(d => d.score < 0).length;
      const lowRisk = displayDrivers.filter(d => d.score >= 0).length;
      const avg = total ? (displayDrivers.reduce((sum, d) => sum + d.score, 0) / total).toFixed(1) : '0.0';
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statHighRisk').textContent = highRisk;
      document.getElementById('statLowRisk').textContent = lowRisk;
      document.getElementById('statAvg').textContent = avg;
    }

    function getScoreColor(score) {
      if (score < 0) {
        const intensity = Math.min(Math.abs(score) / 61, 1);
        const r = Math.floor(220 - (20 * intensity));
        const g = Math.floor(50 + (30 * (1 - intensity)));
        const b = Math.floor(50 + (30 * (1 - intensity)));
        return `rgb(${r}, ${g}, ${b})`;
      } else if (score === 0) {
        return '#95a5a6';
      } else {
        const intensity = Math.min(score / 50, 1);
        const r = Math.floor(100 - (60 * intensity));
        const g = Math.floor(180 + (20 * intensity));
        const b = Math.floor(100 - (60 * intensity));
        return `rgb(${r}, ${g}, ${b})`;
      }
    }

    function renderTable() {
      const area = document.getElementById('tableArea');
      if (!displayDrivers.length) {
        area.innerHTML = '<div class="loading">No data matches filters</div>';
        return;
      }
      
      let html = '<div class="table-wrap"><table class="data-table"><thead><tr>';
      html += '<th>S.No.</th><th>Full Name</th><th>Location</th><th>Region</th><th>Zone</th>';
      html += '<th>Experience Days</th><th>Exp Months</th><th>Driver</th><th>ISAAC Score</th>';
      html += '<th>Ticket #</th><th>Over Speed</th><th>All Collisions</th><th>High Risk Collisions</th>';
      html += '<th>Coachable</th><th>Non Coachable</th><th>Score</th></tr></thead><tbody>';
      
      displayDrivers.forEach(d => {
        const scoreColor = getScoreColor(d.score);
        html += `<tr>
          <td>${d.sno}</td>
          <td title="${d.fullName}">${d.fullName}</td>
          <td>${d.location}</td>
          <td>${d.region}</td>
          <td>${d.zone}</td>
          <td>${d.expDays}</td>
          <td>${d.expMonths}</td>
          <td>${d.driver}</td>
          <td>${d.isaacScore}</td>
          <td>${d.ticketNum}</td>
          <td>${d.overSpeed}</td>
          <td>${d.allCollisions}</td>
          <td>${d.highRiskCollisions}</td>
          <td>${d.coachable}</td>
          <td>${d.nonCoachable}</td>
          <td><span class="score-cell" style="background:${scoreColor}">${d.score.toFixed(1)}</span></td>
        </tr>`;
      });
      html += '</tbody></table></div>';
      area.innerHTML = html;
    }

    function exportCSV() {
      if (!displayDrivers.length) return alert('No data');
      let csv = 'S.No.,Full Name,Location,Region,Zone,Experience Days,Exp Months,Driver,ISAAC Score,Ticket #,Over Speed,All Collisions,High Risk Collisions,Coachable,Non Coachable,Score\n';
      displayDrivers.forEach(d => {
        csv += `${d.sno},"${d.fullName}","${d.location}","${d.region}","${d.zone}",${d.expDays},${d.expMonths},"${d.driver}",${d.isaacScore},${d.ticketNum},${d.overSpeed},${d.allCollisions},${d.highRiskCollisions},${d.coachable},${d.nonCoachable},${d.score.toFixed(1)}\n`;
      });
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `drivers_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }

    function exportPDF() {
      if (!displayDrivers.length) return alert('No data');
      const {jsPDF} = window.jspdf;
      const doc = new jsPDF('landscape');
      doc.setFontSize(16);
      doc.text('Driver Risk Score Report', 14, 15);
      doc.setFontSize(10);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 14, 22);
      doc.text(`Records: ${displayDrivers.length}`, 14, 27);
      
      const tableData = displayDrivers.map(d => {
        const scoreColor = getScoreColor(d.score);
        const rgbMatch = scoreColor.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        const fillColor = rgbMatch ? [parseInt(rgbMatch[1]), parseInt(rgbMatch[2]), parseInt(rgbMatch[3])] : [149, 165, 166];
        return {
          data: [d.sno, d.fullName, d.location, d.region, d.zone, d.expDays, d.expMonths,
                 d.driver, d.isaacScore, d.ticketNum, d.overSpeed, d.allCollisions,
                 d.highRiskCollisions, d.coachable, d.nonCoachable, d.score.toFixed(1)],
          scoreFillColor: fillColor
        };
      });
      
      doc.autoTable({
        head: [['No', 'Name', 'Loc', 'Reg', 'Zone', 'Days', 'Months', 'Drv', 'ISAAC', 'Tkt', 'Speed', 'Coll', 'High', 'Coach', 'Non-C', 'Score']],
        body: tableData.map(row => row.data),
        startY: 32,
        styles: {fontSize: 7, cellPadding: 2},
        headStyles: {fillColor: [52, 73, 94], textColor: [255, 255, 255]},
        didParseCell: function(data) {
          if (data.column.index === 15 && data.section === 'body') {
            data.cell.styles.fillColor = tableData[data.row.index].scoreFillColor;
            data.cell.styles.textColor = [255, 255, 255];
            data.cell.styles.fontStyle = 'bold';
          }
        }
      });
      doc.save(`report_${new Date().toISOString().split('T')[0]}.pdf`);
    }

    function logout() {
      user = null;
      allDrivers = [];
      displayDrivers = [];
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('loginPage').style.display = 'flex';
      document.getElementById('loginForm').reset();
    }

    document.getElementById('filterDrv').addEventListener('change', applyFilters);
    document.getElementById('filterSearch').addEventListener('input', applyFilters);
    document.getElementById('expMin').addEventListener('input', applyFilters);
    document.getElementById('expMax').addEventListener('input', applyFilters);
  </script>
</body>
</html>
